import{c as e,r as t,t as n,j as s,B as r,L as a,I as i,M as o,N as c,O as l,Q as u,R as d,T as p,f as m,o as g,U as h,V as f,Y as x,m as y,s as v,Z as w,F as j,G as b,e as S,u as C,a as R,$ as N,a0 as E,a1 as U,a2 as F,a3 as P}from"./index-BKzwkbhU.js";import{P as k,a as T,b as M,C as D}from"./popover-DU_c79qr.js";import{S as O}from"./skeleton-CF78e7qN.js";import{L as I}from"./loader-circle-C-HlKtqs.js";import{R as L}from"./refresh-cw-g0nJKCu_.js";import{T as A}from"./isSameMonth-CIK_ED-F.js";import{A as $}from"./arrow-right-AykwIgfE.js";import{P as z,u as q}from"./use-toast-C_SwDZk4.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=e("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),_=e("CircleCheck",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),W=e("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),H=e("ScanLine",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["path",{d:"M7 12h10",key:"b7w52i"}]]),V=e("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]),Q=e("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function Y(){const[e,s]=t.useState(0),[r,a]=t.useState(0),i=t.useRef(null),o=t.useCallback((()=>{const e=Date.now();e-r>500&&(s((e=>e+1)),a(e))}),[r]),c=t.useCallback((e=>{const t=e.type;e.detail;null!==i.current&&window.clearTimeout(i.current),i.current=window.setTimeout((()=>{s((e=>e+1)),a(Date.now()),i.current=null,"receipt-scanned"===t?n.success("Receipt processed, expenses added successfully!"):"expense-added"===t?n.success("Expense added successfully!"):"expense-edited"===t?n.success("Expense updated successfully!"):"expense-deleted"===t&&n.success("Expense deleted successfully!")}),300)}),[]);return t.useEffect((()=>(window.addEventListener("expenses-updated",c),window.addEventListener("receipt-scanned",c),window.addEventListener("expense-added",c),window.addEventListener("expense-edited",c),window.addEventListener("expense-deleted",c),window.addEventListener("expense-refresh",c),window.addEventListener("custom-date-change",c),()=>{window.removeEventListener("expenses-updated",c),window.removeEventListener("receipt-scanned",c),window.removeEventListener("expense-added",c),window.removeEventListener("expense-edited",c),window.removeEventListener("expense-deleted",c),window.removeEventListener("expense-refresh",c),window.removeEventListener("custom-date-change",c),null!==i.current&&window.clearTimeout(i.current)})),[c]),{refreshTrigger:e,triggerRefresh:o}}function G({children:e}){return s.jsx("div",{className:"space-y-4",children:e})}function J({isSubmitting:e,isEditing:t}){return s.jsx(r,{type:"submit",className:"w-full",disabled:e,children:e?"Saving...":t?"Update Expense":"Save Expense"})}function K({value:e,onChange:t}){return s.jsxs("div",{className:"space-y-2",children:[s.jsx(a,{htmlFor:"expense-description",children:"Expense Name"}),s.jsx(i,{id:"expense-description",name:"description",type:"text",value:e,onChange:e=>t(e.target.value),placeholder:"Enter expense name",required:!0})]})}function X({value:e,onChange:t}){return s.jsxs("div",{className:"space-y-2",children:[s.jsx(a,{htmlFor:"expense-amount",children:"Amount ($)"}),s.jsx(i,{id:"expense-amount",name:"amount",type:"number",min:"0",step:"0.01",value:e,onChange:e=>t(e.target.value),placeholder:"Enter amount",required:!0})]})}function Z({formData:e,onFieldChange:t}){return s.jsxs(s.Fragment,{children:[s.jsx(K,{value:e.description,onChange:e=>t("description",e)}),s.jsx(X,{value:e.amount,onChange:e=>t("amount",e)})]})}const ee=["Cash","Credit Card","Debit Card","Bank Transfer","PayPal","Mobile Wallet","Other"];function te({value:e,onChange:t}){return s.jsxs("div",{className:"space-y-2",children:[s.jsx(a,{htmlFor:"expense-payment",children:"Payment Method"}),s.jsxs(o,{name:"paymentMethod",value:e,onValueChange:t,children:[s.jsx(c,{id:"expense-payment",className:"bg-background",children:s.jsx(l,{placeholder:"Select payment method"})}),s.jsx(u,{className:"touch-scroll-container max-h-[40vh]",children:ee.map((e=>s.jsx(d,{value:e,children:e},e)))})]})]})}function ne({formData:e,onFieldChange:t}){return s.jsxs(s.Fragment,{children:[s.jsx(p,{value:e.category,onChange:e=>t("category",e)}),s.jsx(te,{value:e.paymentMethod,onChange:e=>t("paymentMethod",e)})]})}function se({value:e,onChange:n,label:i="Date",placeholder:o="Select date...",id:c="expense-date",name:l="date"}){const[u,d]=t.useState(!1),p=e?m(new Date(e),"PP"):"",f=e===(new Date).toISOString().split("T")[0];return s.jsxs("div",{className:"space-y-2",children:[i&&s.jsx(a,{htmlFor:c,children:i}),s.jsxs(k,{open:u,onOpenChange:d,children:[s.jsx(T,{asChild:!0,children:s.jsxs(r,{variant:"outline",id:c,name:l,role:"combobox","aria-expanded":u,className:g("w-full justify-start text-left font-normal",!e&&"text-muted-foreground",f&&"border-primary/70"),children:[s.jsx(h,{className:"mr-2 h-4 w-4"}),e?m(new Date(e),"PPP"):o]})}),s.jsx(M,{className:"w-auto p-0 bg-background/95 backdrop-blur-sm border border-border date-picker-popover",align:"start",children:s.jsx(D,{mode:"single",selected:e?new Date(e):void 0,onSelect:e=>{if(!e)return;const t=m(e,"yyyy-MM-dd");n(t),d(!1)},initialFocus:!0,defaultMonth:e?new Date(e):new Date})})]}),p&&s.jsx("div",{className:g("text-xs",f?"text-primary font-medium":"text-muted-foreground"),children:f?"Today":p})]})}const re=t.forwardRef((({className:e,...t},n)=>s.jsx("textarea",{className:g("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:n,...t})));function ae({value:e,onChange:t}){return s.jsxs("div",{className:"space-y-2",children:[s.jsx(a,{htmlFor:"expense-notes",children:"Notes"}),s.jsx(re,{id:"expense-notes",name:"notes",value:e,onChange:e=>t(e.target.value),placeholder:"Add any additional details about the expense...",className:"min-h-[100px]"})]})}function ie({value:e,onChange:t}){return s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(f,{id:"expense-recurring",name:"isRecurring",checked:e,onCheckedChange:t}),s.jsx(a,{htmlFor:"expense-recurring",children:"Recurring Expense"})]})}function oe({formData:e,onFieldChange:t}){return s.jsxs(s.Fragment,{children:[s.jsx(se,{value:e.date,onChange:e=>t("date",e)}),s.jsx(ae,{value:e.notes,onChange:e=>t("notes",e)}),s.jsx(ie,{value:e.isRecurring,onChange:e=>t("isRecurring",e)})]})}function ce({url:e,alt:t="Receipt preview",className:n,isProcessing:r=!1,onLoad:a}){const[i,o]=x.useState(!0),[c,l]=x.useState(!1);return s.jsxs("div",{className:"relative rounded-md overflow-hidden",children:[i&&!c&&s.jsx(O,{className:"w-full aspect-[3/4] rounded-md"}),s.jsxs(y.div,{className:g("relative rounded-md overflow-hidden",r&&"animate-scan-line border-2 border-primary",n),initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},children:[s.jsx("img",{src:e,alt:t,className:g("w-full h-auto object-contain rounded-md",i&&"hidden"),onLoad:()=>{o(!1),a&&a()},onError:()=>{o(!1),l(!0)}}),r&&s.jsx(y.div,{className:"absolute inset-0 bg-primary/5 pointer-events-none",initial:{opacity:0},animate:{opacity:[0,.1,0,.1,0]},transition:{repeat:1/0,duration:3}})]}),c&&s.jsx("div",{className:"w-full aspect-[3/4] bg-muted rounded-md flex items-center justify-center",children:s.jsx("p",{className:"text-xs text-muted-foreground",children:"Failed to load image"})})]})}function le({receiptUrl:e,onReplace:n,className:r="",disabled:a=!1}){const[i,o]=t.useState(!0);if(!e)return s.jsx("div",{className:"rounded-md border bg-muted h-[150px] flex items-center justify-center",children:s.jsx("p",{className:"text-muted-foreground text-sm",children:"No receipt uploaded"})});return s.jsxs("div",{className:"relative border rounded-md overflow-hidden "+(a?"opacity-75":"opacity-100"),onClick:!a&&n?n:void 0,children:[i&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:s.jsx(O,{className:"h-full w-full"})}),s.jsx(ce,{url:e,onLoad:()=>{o(!1)},className:`w-full h-auto object-contain ${r}`}),!a&&n&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/5 opacity-0 hover:opacity-100 transition-opacity cursor-pointer",children:s.jsx("div",{className:"text-xs text-white bg-black/70 px-2 py-1 rounded",children:"Click to replace"})})]})}re.displayName="Textarea";const ue=[1500,3e3];function de(e){return[{description:"Store Purchase",amount:"0.00",date:(new Date).toISOString().split("T")[0],category:"Other",paymentMethod:"Card",receiptUrl:e}]}function pe({file:e,onCleanup:s,onCapture:r,setOpen:a,autoSave:i=!0,onSuccess:o,processAllItems:c=!1}){const[l,u]=t.useState(!1),[d,p]=t.useState(!1),[m,g]=t.useState(0),[h,f]=t.useState(),[x,y]=t.useState(!1),[w,j]=t.useState(null),[b,S]=t.useState(!1),C=t.useCallback((()=>{u(!1),p(!1),g(0),f(void 0),y(!1),j(null),S(!1)}),[]),R=t.useCallback(((e,t)=>{g(e),t&&f(t)}),[]),N=t.useCallback((()=>{u(!0),p(!0),g(0),y(!1),j(null),S(!1)}),[]),E=t.useCallback((()=>{y(!0),u(!1),p(!1),n.error("Receipt scan timed out. Please try again.")}),[]),U=t.useCallback((e=>{j(e),u(!1),p(!1),n.error("Error scanning receipt: "+e)}),[]),F=t.useCallback((()=>{u(!1),p(!1)}),[]),P=t.useCallback((async()=>{if(!e)return void n.error("No receipt file selected");if(l)return void n.info("Scan already in progress");N();const t=e?URL.createObjectURL(e):void 0;try{const l=await async function({file:e,receiptUrl:t,onProgress:s,onTimeout:r,onError:a}){var i;if(!e){const e="No file provided";return a&&a(e),{success:!1,error:e}}if(!e.type.startsWith("image/")){const t=`File is not an image: ${e.type}`;return a&&a(t),{success:!1,error:t}}let o=t;t&&t.startsWith("blob:")&&(o=void 0);let c=0;for(;c<=2;)try{c>0?(null==s||s(5,`Retrying scan (attempt ${c+1})...`),await new Promise((e=>setTimeout(e,ue[c-1]||3e3)))):null==s||s(10,"Preparing receipt for scanning...");const t=new FormData;t.append("file",e),o&&t.append("receiptUrl",o),t.append("timestamp",Date.now().toString()),t.append("retry",c.toString()),t.append("enhanced","true"),null==s||s(30,"Processing receipt image...");const d=new AbortController,p=setTimeout((()=>{d.abort()}),3e4);try{for(const[n,s]of t.entries())File;const{data:e,error:u}=await v.functions.invoke("scan-receipt",{method:"POST",body:t,headers:{"X-Processing-Level":"high"}});if(clearTimeout(p),null==s||s(60,"Extracting data from receipt..."),u)throw new Error(`Supabase function error: ${u.message||"Unknown error"}`);if(!e)throw new Error("No data returned from scan function");if(!0===e.isTimeout)return(null==(i=e.items)?void 0:i.length)>0?{success:!0,...e}:(r&&r(),{success:!1,isTimeout:!0,error:"Processing timed out",date:e.date||(new Date).toISOString().split("T")[0],items:de(o)});if(e.error){if(c>=2)return a&&a(e.error),{success:!1,error:e.error,date:e.date||(new Date).toISOString().split("T")[0],items:e.items||de(o)};throw new Error(e.error)}null==s||s(80,"Processing scan results..."),e.warning&&n.warning(e.warning||"Receipt processed with limited accuracy");const d={success:!0,items:Array.isArray(e.items)?e.items:[],date:e.date||(new Date).toISOString().split("T")[0],total:e.total||"0.00",receiptUrl:o};d.items&&0!==d.items.length||(d.items=[{description:"Store Purchase",amount:d.total||"0.00",date:d.date,category:"Other",paymentMethod:"Card"}]);try{sessionStorage.setItem("lastScanResult",JSON.stringify(d))}catch(l){}return null==s||s(100,"Receipt processed successfully!"),d}catch(u){throw clearTimeout(p),u}}catch(d){if(c++,c>2){if(d instanceof Error&&"AbortError"===d.name)return r&&r(),{success:!1,isTimeout:!0,error:"Processing timed out",date:(new Date).toISOString().split("T")[0],items:de(o)};const e=d instanceof Error?"TypeError"===d.name&&d.message.includes("fetch")?"Network error: Please check your internet connection":d.message:"Unknown error occurred";return a&&a(e),{success:!1,error:e,date:(new Date).toISOString().split("T")[0],items:de(o)}}}return{success:!1,error:"Failed after multiple attempts",date:(new Date).toISOString().split("T")[0],items:de(o)}}({file:e,receiptUrl:t,onProgress:R,onTimeout:E,onError:U});if((null==l?void 0:l.success)&&l.items&&l.items.length>0){R(90,"Extracting expense information...");const e=(s=l.items)&&0!==s.length?1===s.length?s[0]:s.reduce(((e,t)=>{const n=parseFloat(e.amount||"0");return parseFloat(t.amount||"0")>n?t:e}),s[0]):{},t=(new Date).toISOString().split("T")[0];let u={description:e.description||"Store Purchase",amount:e.amount||"0.00",date:e.date||l.date||t,category:e.category||"Other",paymentMethod:e.paymentMethod||"Card"};if(i)try{if(R(95,"Saving expenses to database..."),c&&l.items.length>1){const s={items:l.items,merchant:l.merchant||e.description||"Store",date:l.date||t},r=await async function(e){try{const{data:{user:t}}=await v.auth.getUser();if(!t)return n.error("Please log in to save expenses"),!1;const s=e.items.map((e=>({user_id:t.id,description:e.description,amount:parseFloat(e.amount.toString().replace("$","")),date:e.date,category:e.category||"Food",receipt_url:e.receiptUrl||null,payment:e.paymentMethod,is_recurring:!1,created_at:(new Date).toISOString()}))),{data:r,error:a}=await v.from("expenses").insert(s);if(a)return n.error("Failed to save expenses: "+a.message),!1;n.success("Expenses added successfully");const i=new CustomEvent("expenses-updated",{detail:{timestamp:Date.now()}});return window.dispatchEvent(i),!0}catch(t){return n.error("An unexpected error occurred"),!1}}(s);if(r){R(100,"All expenses saved successfully!"),S(!0),o&&o();const e=new CustomEvent("receipt-scanned",{detail:{items:l.items,timestamp:Date.now()}});window.dispatchEvent(e)}else R(100,"Failed to save all expenses, but form updated"),U("Failed to save expenses to database")}else r&&r(u),R(100,"Receipt processed successfully!"),S(!0)}catch(a){R(100,"Error saving to database"),U("Failed to save to database")}else r&&(r(u),R(100,"Receipt processed successfully!"),S(!0))}else(null==l?void 0:l.isTimeout)?E():(null==l?void 0:l.error)?U(l.error):U("Failed to extract data from receipt")}catch(a){U("An unexpected error occurred")}finally{F()}var s}),[e,l,N,R,E,U,i,r,o,F,c]),k=t.useCallback((()=>{P()}),[P]);return{isScanning:l,scanProgress:m,scanTimedOut:x,scanError:w,statusMessage:h,handleScanReceipt:P,isAutoProcessing:d,processingComplete:b,autoProcessReceipt:k,resetScanState:C}}function me({isScanning:e,scanTimedOut:t,onClick:n,disabled:a,autoSave:i=!1,isAutoProcessing:o=!1,scanProgress:c=0,statusMessage:l}){const u=()=>e?"Processing...":o?"Auto-Processing...":t?"Retry Scan":"Process Receipt"+(i?" & Save":""),d=Math.round(c),p=t?"destructive":"default";return s.jsx(r,{type:"button",variant:p,onClick:n,disabled:a,className:"flex-1",children:e||o?s.jsxs(s.Fragment,{children:[s.jsx(I,{className:"mr-2 h-4 w-4 animate-spin"}),u(),c>0&&s.jsxs("span",{className:"ml-1 text-xs",children:["(",d,"%)"]})]}):t?s.jsxs(s.Fragment,{children:[s.jsx(L,{className:"mr-2 h-4 w-4"}),u()]}):s.jsxs(s.Fragment,{children:[s.jsx(H,{className:"mr-2 h-4 w-4"}),u()]})})}function ge({previewUrl:e,isScanning:t,isAutoProcessing:n,scanProgress:a,statusMessage:i,scanTimedOut:o,scanError:c,handleScanReceipt:l,onCleanup:u,fileExists:d,processingComplete:p,autoProcess:m=!0,children:g}){return s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(w,{className:"h-5 w-5 text-primary"}),s.jsx("h2",{className:"text-xl font-semibold",children:p?"Receipt Processed!":c?"Processing Error":o?"Processing Timed Out":"Processing Receipt..."})]}),e&&s.jsxs("div",{className:"relative mt-2 bg-card/30 rounded-lg p-2 border border-border",children:[s.jsx("img",{src:e,className:"mx-auto w-full h-auto max-h-[300px] rounded object-contain",alt:"Receipt preview"}),(t||n)&&s.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-black/50 rounded-lg text-white",children:[s.jsx("p",{className:"mb-4 text-center px-4",children:i||"Processing receipt image..."}),s.jsx("div",{className:"w-4/5",children:g})]}),c&&!t&&!n&&s.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-black/50 rounded-lg text-white",children:[s.jsx(A,{className:"h-12 w-12 text-destructive mb-2"}),s.jsx("p",{className:"text-center px-4",children:"Error processing receipt"})]}),p&&!t&&!n&&s.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-black/50 rounded-lg text-white",children:[s.jsx(_,{className:"h-12 w-12 text-green-500 mb-2"}),s.jsx("p",{className:"text-center px-4",children:"Receipt processed successfully!"})]})]}),s.jsxs("div",{className:"flex flex-col space-y-4",children:[!p&&s.jsxs(s.Fragment,{children:[(c||o)&&!t&&!n&&s.jsx("div",{className:"p-3 bg-destructive/10 text-destructive rounded-md text-sm",children:o?s.jsx("p",{children:"Processing is taking longer than expected. Please try again."}):s.jsx("p",{children:"There was an error processing your receipt. Please try again."})}),s.jsxs("div",{className:"flex space-x-2",children:[s.jsx(r,{type:"button",variant:"outline",onClick:u,className:"flex-1",disabled:t||n,children:"Cancel"}),s.jsx(me,{isScanning:t,scanTimedOut:o,onClick:l,disabled:!d||t||n,autoSave:!0,isAutoProcessing:n,scanProgress:a,statusMessage:i})]})]}),p&&!t&&!n&&s.jsxs(r,{type:"button",variant:"default",onClick:u,className:"w-full",children:["Close ",s.jsx($,{className:"ml-1 h-4 w-4"})]})]})]})}function he({isScanning:e,processingComplete:n}){const[r,a]=t.useState(0);t.useEffect((()=>{if(!e)return void a(0);let t,s=Date.now();const i=()=>{const e=Date.now(),o=e-s;let c;s=e,c=r<30?.012:r<60?.008:r<80?.004:.002,a((e=>{if(n)return 100;if(e>=95)return e;const t=c*o;return Math.min(e+t,95)})),n||(t=requestAnimationFrame(i))};return t=requestAnimationFrame(i),()=>{cancelAnimationFrame(t)}}),[e,n]);const i=function(e){return e<20?"bg-amber-400":e<40?"bg-yellow-400":e<60?"bg-blue-400":e<80?"bg-blue-500":e<95?"bg-emerald-400":"bg-emerald-500"}(r);return s.jsx("div",{className:"w-full max-w-[300px] px-4",children:s.jsxs(y.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},transition:{duration:.3},children:[s.jsx(z,{value:r,className:"h-2 bg-secondary",indicatorClassName:i}),s.jsxs("div",{className:"flex justify-between text-xs mt-1 text-muted-foreground",children:[s.jsx("span",{children:"0%"}),s.jsxs("span",{className:"font-medium",children:[Math.round(r),"%"]}),s.jsx("span",{children:"100%"})]})]})})}function fe({file:e,previewUrl:r,open:a,setOpen:i,onCleanup:o,onCapture:c,autoSave:l=!0,autoProcess:u=!0,onSuccess:d}){const[p,m]=t.useState(!1),g=t.useRef(null);t.useEffect((()=>{e&&(g.current=`${e.name}-${e.size}-${e.lastModified}`)}),[e]);const{isScanning:h,scanProgress:f,scanTimedOut:x,scanError:y,statusMessage:v,handleScanReceipt:w,isAutoProcessing:S,processingComplete:C,autoProcessReceipt:R,resetScanState:N}=pe({file:e,onCleanup:o,onCapture:c,autoSave:l,setOpen:i,onSuccess:d,processAllItems:!0}),E=function({scanTimedOut:e,scanError:s,isScanning:r,isAutoProcessing:a,processingComplete:i,resetScanState:o,autoProcessReceipt:c,onCapture:l,setOpen:u}){const[d,p]=t.useState(0),[m,g]=t.useState(!1),h=t.useCallback((()=>{r||a||(g(!0),p((e=>e+1)),o(),c())}),[r,a,d,o,c]),f=t.useCallback((()=>{(e||s)&&(d<3?(n.info("Retrying receipt scan..."),h()):(n.error("Maximum retry attempts reached. Please try uploading the receipt again."),u(!1)))}),[e,s,d,h,u]),x=d>=3,y=t.useCallback((()=>m),[m]);return{attemptCount:d,setAttemptCount:p,isProcessing:m,setProcessing:g,handleRetry:f,startProcessing:h,isMaxAttemptsReached:x,resetAndClose:()=>{if(o(),g(!1),p(0),u(!1),i){const e=new CustomEvent("receipt-scanned",{detail:{timestamp:Date.now()}});window.dispatchEvent(e);const t=new CustomEvent("expenses-updated",{detail:{timestamp:Date.now()}});window.dispatchEvent(t)}},isProcessingInProgress:y}}({scanTimedOut:x,scanError:y,isScanning:h,isAutoProcessing:S,processingComplete:C,resetScanState:N,autoProcessReceipt:R,onCapture:c,setOpen:i}),{handleClose:U}=function({open:e,onCleanup:n}){const[s,r]=t.useState(!1);return t.useEffect((()=>{if(!e&&!s){const e=setTimeout((()=>{n(),r(!0)}),300);return()=>clearTimeout(e)}}),[e,n,s]),t.useEffect((()=>{e&&r(!1)}),[e]),{hasCleanedUp:s,setHasCleanedUp:r,handleClose:(e,t)=>!e&&!t&&(s||(setTimeout((()=>{n()}),300),r(!0)),!0)}}({open:a,onCleanup:o});t.useEffect((()=>{if(a&&e&&!h&&!S&&u&&!p&&!E.isProcessingInProgress()){m(!0);const e=setTimeout((()=>{E.startProcessing()}),300);return()=>clearTimeout(e)}}),[a,e,h,S,u,p,E]),t.useEffect((()=>{a||(m(!1),E.setAttemptCount(0),E.setProcessing(!1))}),[a,E]),t.useEffect((()=>{if(C&&a&&!h&&!S){const e=setTimeout((()=>{i(!1)}),1500);return()=>clearTimeout(e)}}),[C,a,h,S,i]);return s.jsx(j,{open:a,onOpenChange:e=>{!e&&U(h,S)?(E.setProcessing(!1),i(!1)):i(!0)},children:s.jsx(b,{className:"sm:max-w-md md:max-w-lg lg:max-w-xl",children:s.jsx(ge,{previewUrl:r,isScanning:h,isAutoProcessing:S,scanProgress:f,statusMessage:v,scanTimedOut:x,scanError:!!y,handleScanReceipt:w,onCleanup:()=>U(h,S),fileExists:!!e,processingComplete:C,autoProcess:u,children:s.jsx(he,{isScanning:h||S,processingComplete:C})})})})}function xe({icon:e,children:t,...n}){const a={upload:Q,camera:B,retry:W}[e];return s.jsxs(r,{...n,children:[s.jsx(a,{className:"mr-2 h-4 w-4"}),t]})}function ye({onUpload:e,onCapture:t,onRetry:n,receiptUrl:r,showCameraButton:a=!1,showRetryButton:i=!1,isProcessing:o=!1}){const c=!!r;return s.jsx("div",{className:"flex flex-col sm:flex-row gap-2",children:c?s.jsxs(s.Fragment,{children:[s.jsx(xe,{type:"button",variant:"outline",icon:"upload",onClick:e,disabled:o,className:"flex-1",children:"Replace Receipt"}),i&&n&&s.jsx(xe,{type:"button",variant:"outline",icon:"retry",onClick:n,disabled:o,className:"flex-1",children:"Retry Scan"})]}):s.jsxs(s.Fragment,{children:[s.jsx(xe,{type:"button",variant:"outline",icon:"upload",onClick:e,disabled:o,className:"flex-1",children:"Upload Receipt"}),a&&t&&s.jsx(xe,{type:"button",variant:"outline",icon:"camera",onClick:t,disabled:o,className:"flex-1",children:"Take Photo"})]})})}function ve({id:e,onChange:t,inputRef:n,useCamera:r,accept:a="image/*"}){return s.jsx("input",{type:"file",id:e,name:e,accept:a,capture:r?"environment":void 0,className:"hidden",onChange:t,ref:n})}const we=new Map;function je(e){if(e&&e.startsWith("blob:")&&we.has(e)){const t=we.get(e);if(t){const n=Math.max(0,t.references-1);we.set(e,{...t,inUse:n>0,references:n})}}}function be(e){if(e&&e.startsWith("blob:"))if(we.has(e)){const t=we.get(e);we.set(e,{...t,inUse:!0,references:t.references+1}),t.references}else we.set(e,{inUse:!0,created:Date.now(),references:1})}function Se(){const e=Date.now();we.forEach(((t,n)=>{if(!t.inUse&&0===t.references&&e-t.created>5e3)try{t.created,URL.revokeObjectURL(n),we.delete(n)}catch(s){we.delete(n)}}))}const Ce=new Map;async function Re(e,t,s){try{if(!e)return null;const s=function(e){return`${e.name}-${e.size}-${e.lastModified}`}(e);if(Ce.has(s))return Ce.get(s);const r=async function(e,t){const s=Date.now(),r=Math.random().toString(36).substring(2,10),a=e.name.split(".").pop(),i=`${s}-${r}.${a}`,o=t?`users/${t}/${i}`:`public/${i}`,c="receipts";try{await async function(e){try{const{error:t}=await v.storage.from(e).list("",{limit:1});if(!t)return!0;const{error:n}=await v.storage.createBucket(e,{public:!0,fileSizeLimit:10485760});return n&&n.message.includes("already exists"),!0}catch(s){return!0}}(c);const{data:t,error:s}=await v.storage.from(c).upload(o,e,{cacheControl:"3600",upsert:!0});if(s)return n.error(`Upload failed: ${s.message}`),null;const{data:{publicUrl:r}}=v.storage.from(c).getPublicUrl(o);return r}catch(l){return null}}(e,t);return Ce.set(s,r),setTimeout((()=>{Ce.delete(s)}),6e4),r}catch(r){return null}}const Ne=new Map;let Ee=0;function Ue(e){return`${e.name}-${e.size}-${e.lastModified}`}async function Fe(e,t,s,r,a){try{if(!e)return null;if(!e.type.startsWith("image/"))return n.error("Please upload an image file"),null;const o=Ue(e),c=Date.now();if(c-Ee<1e3)return n.warning("Please wait a moment before uploading another file"),null;Ee=c;const l=Ne.get(o);if(l){if(l.inProgress)return n.info("This file is already being processed"),null;if(c-l.timestamp<1e4)return l.receiptUrl?(r("receiptUrl",l.receiptUrl),l.receiptUrl):null}Ne.set(o,{timestamp:c,inProgress:!0}),a&&a(!0);try{const n=function(e){const t=URL.createObjectURL(e);return we.set(t,{inUse:!0,created:Date.now(),references:1}),t}(e);s&&setTimeout((()=>{je(s)}),500),r("receiptUrl",n),r("receiptFile",e),be(n);try{const s=await Re(e,t);return s?(je(n),je(n),r("receiptUrl",s),Ne.set(o,{timestamp:Date.now(),inProgress:!1,receiptUrl:s}),s):(je(n),Ne.set(o,{timestamp:Date.now(),inProgress:!1,receiptUrl:n}),n)}catch(i){return je(n),Ne.set(o,{timestamp:Date.now(),inProgress:!1,receiptUrl:n}),n}finally{setTimeout(Se,2e3)}}catch(i){throw Ne.set(o,{timestamp:Date.now(),inProgress:!1}),i}finally{a&&a(!1)}}catch(i){return n.error("Failed to process receipt file"),null}}setInterval((()=>{const e=Date.now();for(const[t,n]of Ne.entries())e-n.timestamp>18e5&&Ne.delete(t)}),6e4);const Pe=new Map;function ke({receiptUrl:e,onFileChange:n,setFileInputRef:r,setCameraInputRef:i,onCapture:o,autoProcess:c=!0}){const l=t.useRef(null),u=t.useRef(null),d=S(),[p,m]=t.useState(!1),[g,h]=t.useState(null),[f,x]=t.useState(null),[y,v]=t.useState(!1),w=t.useRef(null);t.useEffect((()=>{r&&l.current&&r(l.current),i&&u.current&&i(u.current)}),[r,i]);const j=()=>{!y&&l.current&&l.current.click()},b=e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(!s)return;const r=Ue(s);if(Pe.has(r))return;Pe.set(r,!0),w.current=r,v(!0);const a=URL.createObjectURL(s);x(a),h(s),c&&m(!0),n(e),e.target&&(e.target.value="")};return t.useEffect((()=>()=>{f&&URL.revokeObjectURL(f),w.current&&Pe.delete(w.current)}),[]),s.jsxs("div",{className:"space-y-2",children:[s.jsx(a,{htmlFor:"expense-receipt",children:"Receipt"}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(le,{receiptUrl:e,onReplace:j}),s.jsx(ve,{id:"expense-receipt",onChange:b,inputRef:l,useCamera:!1,accept:"image/*"}),s.jsx(ve,{id:"camera-capture",onChange:b,inputRef:u,useCamera:!0,accept:"image/*"}),s.jsx(ye,{receiptUrl:e,onUpload:j,onCapture:d?()=>{!y&&u.current&&u.current.click()}:void 0,onRetry:g&&c?()=>{g&&f&&m(!0)}:void 0,showCameraButton:d,showRetryButton:!!g&&c,isProcessing:y})]}),g&&c&&s.jsx(fe,{file:g,previewUrl:f,open:p,setOpen:m,onCleanup:()=>{w.current&&(Pe.delete(w.current),w.current=null),f&&(URL.revokeObjectURL(f),x(null)),h(null),v(!1)},onCapture:o,autoSave:!0,autoProcess:!0})]})}function Te({receiptUrl:e,onFileChange:n,isUploading:r=!1,setFileInputRef:a,setCameraInputRef:i,onCapture:o,isManualForm:c=!1}){const[l,u]=t.useState(!!e);return t.useEffect((()=>{u(!!e)}),[e]),s.jsxs("div",{children:[s.jsx("h3",{className:"text-base font-medium mb-2",children:"Receipt"}),s.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:c?"Upload a receipt image to attach to this expense":"Upload a receipt image and we'll automatically extract all items as expenses"}),s.jsx(ke,{receiptUrl:e,onFileChange:n,setFileInputRef:a,setCameraInputRef:i,onCapture:o,autoProcess:!c}),r&&s.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Uploading receipt..."}),l&&!r&&s.jsx("p",{className:"text-xs text-green-600 mt-2",children:"Receipt successfully uploaded"})]})}function Me({formData:e,isSubmitting:t,isEditing:n,isUploading:r=!1,onSubmit:a,onFieldChange:i,onFileChange:o,setFileInputRef:c,setCameraInputRef:l,onScanComplete:u,isManualEntry:d=!0}){return s.jsxs("form",{onSubmit:a,className:"space-y-4 mt-4",children:[s.jsx(G,{children:s.jsx(Z,{formData:e,onFieldChange:i})}),s.jsx(G,{children:s.jsx(ne,{formData:e,onFieldChange:i})}),s.jsx(G,{children:s.jsx(oe,{formData:e,onFieldChange:i})}),s.jsx(G,{children:s.jsx(Te,{receiptUrl:e.receiptUrl,onFileChange:o,isUploading:r,setFileInputRef:c,setCameraInputRef:l,onCapture:u,isManualForm:d})}),s.jsx(J,{isSubmitting:t||r,isEditing:n})]})}function De({formData:e,updateField:n}){var s;const r=C(),a=(null==(s=null==r?void 0:r.user)?void 0:s.id)||null,[i,o]=t.useState(!1),c=t.useRef(null);return t.useEffect((()=>()=>{setTimeout((()=>{we.size,we.forEach(((e,t)=>{try{URL.revokeObjectURL(t)}catch(n){}})),we.clear()}),1e3)}),[]),{processReceiptFile:async e=>{try{return await Fe(e,a,c.current,n,o)}catch(t){return null}},isUploading:i}}function Oe({updateField:e}){return{handleScanComplete:t.useCallback((()=>{try{const n=sessionStorage.getItem("lastScanResult");if(!n)return;const s=JSON.parse(n);if(s.items&&s.items.length>0){const n=(t=s.items)&&0!==t.length?1===t.length?t[0]:t.reduce(((e,t)=>{const n=parseFloat(e.amount||"0");return parseFloat(t.amount||"0")>n?t:e}),t[0]):{};n.name?e("description",function(e){if(!e)return"";let t=e.replace(/^item[:.\s-]+/i,"").replace(/^product[:.\s-]+/i,"").replace(/^[a-z]{1,3}\d{4,}[:.\s-]*/i,"");t.length>50&&(t=t.substring(0,50)+"...");t.length>0&&(t=t.charAt(0).toUpperCase()+t.slice(1));return t}(n.name)):s.storeName&&e("description",`Purchase from ${s.storeName}`),n.amount&&e("amount",n.amount),n.date&&e("date",function(e){try{if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=new Date(e);return isNaN(t.getTime())?(new Date).toISOString().split("T")[0]:t.toISOString().split("T")[0]}catch(t){return(new Date).toISOString().split("T")[0]}}(n.date)),n.category&&e("category",n.category),e("paymentMethod","Card"),sessionStorage.removeItem("lastScanResult")}}catch(n){}var t}),[e])}}const Ie=e=>{try{if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=new Date(e);if(!isNaN(t.getTime()))return e}const t=new Date(e);if(!isNaN(t.getTime()))return t.toISOString().split("T")[0];const n=e.split(/[-\/\.]/);if(3===n.length){const e=[new Date(`${n[2]}-${n[0]}-${n[1]}`),new Date(`${n[2]}-${n[1]}-${n[0]}`)];for(const t of e)if(!isNaN(t.getTime()))return t.toISOString().split("T")[0]}const s=e.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);if(s){const e=parseInt(s[1],10),t=parseInt(s[2],10),n=parseInt(s[3],10);if(e>=1&&e<=31&&t>=1&&t<=12&&n>=2e3&&n<=2100)return`${n}-${t.toString().padStart(2,"0")}-${e.toString().padStart(2,"0")}`}return(new Date).toISOString().split("T")[0]}catch(t){return(new Date).toISOString().split("T")[0]}},Le=e=>{let t=e.replace(/[^\d.,]/g,"");t.includes(",")&&!t.includes(".")?t=t.replace(",","."):t.includes(",")&&t.includes(".")&&(t=t.indexOf(",")<t.indexOf(".")?t.replace(/,/g,""):t.replace(/\./g,"").replace(",","."));const n=parseFloat(t);return isNaN(n)?"0.00":n.toFixed(2)},Ae=e=>{const t=e.toLowerCase();return t.includes("grocer")||t.includes("food")||t.includes("supermarket")||t.includes("market")||t.includes("mart")||t.includes("aldi")||t.includes("lidl")||t.includes("tesco")||t.includes("sainsbury")||t.includes("carrefour")||t.includes("edeka")||t.includes("kaufland")||t.includes("rewe")?"Groceries":t.includes("restaurant")||t.includes("cafe")||t.includes("bar")||t.includes("food")||t.includes("burger")||t.includes("pizza")||t.includes("coffee")?"Dining":t.includes("gas")||t.includes("fuel")||t.includes("petrol")||t.includes("taxi")||t.includes("uber")||t.includes("train")||t.includes("transport")?"Transportation":t.includes("store")||t.includes("shop")||t.includes("mall")||t.includes("retail")||t.includes("purchase")?"Shopping":"Other"};function $e({expenseToEdit:e,onClose:s,onAddExpense:r}){const a=t.useRef(null),i=t.useRef(null),[o,c]=t.useState({amount:(null==e?void 0:e.amount.toString())||"",description:(null==e?void 0:e.description)||"",date:(null==e?void 0:e.date)||(new Date).toISOString().split("T")[0],category:(null==e?void 0:e.category)||"Other",paymentMethod:(null==e?void 0:e.paymentMethod)||"Cash",notes:(null==e?void 0:e.notes)||"",isRecurring:(null==e?void 0:e.isRecurring)||!1,receiptFile:null,receiptUrl:(null==e?void 0:e.receiptUrl)||""});t.useEffect((()=>{e&&c({amount:e.amount.toString(),description:e.description,date:e.date,category:e.category,paymentMethod:e.paymentMethod||"Cash",notes:e.notes||"",isRecurring:e.isRecurring||!1,receiptFile:null,receiptUrl:e.receiptUrl||""})}),[e]);const l=(e,t)=>{c((n=>({...n,[e]:t})))},{processReceiptFile:u,isUploading:d}=De({formData:o,updateField:l}),{handleScanComplete:p}=Oe({updateField:l}),{isSubmitting:m,handleSubmit:g}=function({expenseToEdit:e,onClose:n,formData:s,resetForm:r,onAddExpense:a}){const{user:i}=C(),{toast:o}=q(),c=R(),[l,u]=t.useState(!1);return{isSubmitting:l,handleSubmit:async t=>{if(t.preventDefault(),s.amount&&s.description&&s.date&&s.category&&i){u(!0);try{const t={user_id:i.id,amount:parseFloat(s.amount),description:s.description,date:s.date,category:s.category,payment:s.paymentMethod,notes:s.notes,is_recurring:s.isRecurring,receipt_url:s.receiptUrl};let l,u=null;if(e){const{error:n}=await v.from("expenses").update(t).eq("id",e.id);l=n,l||(u={...e,amount:parseFloat(s.amount),description:s.description,date:s.date,category:s.category,paymentMethod:s.paymentMethod,notes:s.notes,isRecurring:s.isRecurring,receiptUrl:s.receiptUrl})}else{const{data:e,error:n}=await v.from("expenses").insert([t]).select("id").single();l=n,!l&&e&&(u={id:e.id,amount:parseFloat(s.amount),description:s.description,date:s.date,category:s.category,paymentMethod:s.paymentMethod,notes:s.notes||"",isRecurring:s.isRecurring,receiptUrl:s.receiptUrl||""})}if(l)throw l;await c.invalidateQueries({queryKey:["expenses"]}),await c.invalidateQueries({queryKey:["budgets"]}),a&&u&&a(u),o({title:e?"Expense Updated":"Expense Added",description:e?"Your expense has been updated successfully.":"Your expense has been added successfully."}),r(),null==n||n()}catch(l){o({title:"Error",description:"Failed to save the expense. Please try again.",variant:"destructive"})}finally{u(!1)}}}}}({expenseToEdit:e,onClose:s,formData:o,resetForm:()=>{c({amount:"",description:"",date:(new Date).toISOString().split("T")[0],category:"Other",paymentMethod:"Cash",notes:"",isRecurring:!1,receiptFile:null,receiptUrl:""})},onAddExpense:r});return{formData:o,isSubmitting:m,isUploading:d,updateField:l,handleFileChange:e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];n&&(l("receiptFile",n),u(n),e.target&&(e.target.value=""))},handleScanComplete:e=>{const t={description:e.description||"Store Purchase",amount:Le(e.amount||"0.00"),date:Ie(e.date||(new Date).toISOString().split("T")[0]),category:e.category||Ae(e.description)||"Other",paymentMethod:e.paymentMethod||"Card"};l("description",t.description),t.amount&&l("amount",t.amount),t.date&&l("date",t.date),l("category",t.category),l("paymentMethod",t.paymentMethod),n.success("Receipt scanned and form updated"),p()},handleSubmit:g,triggerFileUpload:()=>{a.current&&a.current.click()},triggerCameraCapture:()=>{i.current&&i.current.click()},setFileInputRef:e=>{a.current=e},setCameraInputRef:e=>{i.current=e},processReceiptFile:u}}const ze=new Map,qe=({onAddExpense:e,expenseToEdit:r,onClose:a,open:i,onOpenChange:o,initialCaptureMode:c="manual",initialFile:l=null})=>{const[u,d]=t.useState(!1),[p,m]=t.useState(null),[g,h]=t.useState(null),f=t.useRef(!1),x=t.useRef(null),[y,v]=t.useState(!1),{formData:w,isSubmitting:j,isUploading:b,updateField:S,handleFileChange:C,handleSubmit:R,setFileInputRef:k,setCameraInputRef:T,handleScanComplete:M,processReceiptFile:D}=$e({expenseToEdit:r,onClose:a,onAddExpense:e}),O="manual"===c||!!r;t.useEffect((()=>{if(i&&!r&&l&&!f.current){const t=Ue(l);if(x.current=t,ze.has(t))return;ze.set(t,!0),f.current=!0;try{const e=URL.createObjectURL(l);m(e),setTimeout((()=>{D(l).catch((e=>{h("Failed to process receipt image"),ze.delete(t)}))}),100),"manual"!==c&&d(!0)}catch(e){n.error("Failed to process the receipt image"),x.current&&ze.delete(x.current)}}}),[i,r,l,c,D]),t.useEffect((()=>{i||(f.current=!1,x.current&&(ze.delete(x.current),x.current=null),v(!1))}),[i]),t.useEffect((()=>()=>{p&&URL.revokeObjectURL(p),x.current&&ze.delete(x.current)}),[p]);const I=()=>{p&&(URL.revokeObjectURL(p),m(null)),d(!1),h(null),x.current&&ze.delete(x.current)};return s.jsxs(s.Fragment,{children:[s.jsx(N,{open:i,onOpenChange:e=>{e?o&&o(!0):(I(),o&&o(!1),a&&a())},children:s.jsxs(E,{className:"overflow-y-auto",children:[s.jsxs(U,{children:[s.jsx(F,{children:r?"Edit Expense":"Add New Expense"}),s.jsx(P,{children:r?"Edit your expense details below.":O?"Enter expense details manually.":"Upload a receipt for automatic processing."})]}),s.jsx(Me,{formData:w,isSubmitting:j,isEditing:!!r,isUploading:b,onSubmit:R,onFieldChange:S,onFileChange:C,setFileInputRef:k,setCameraInputRef:T,onScanComplete:M,isManualEntry:O})]})}),!O&&l&&p&&s.jsx(fe,{file:l,previewUrl:p,open:u,setOpen:d,onCleanup:I,onCapture:M,autoSave:!0,autoProcess:!0,onSuccess:()=>{v(!0),e&&e(),setTimeout((()=>{o&&o(!1),a&&a()}),1e3)}})]})};export{qe as A,B as C,ve as R,V as S,Q as U,be as a,je as m,Y as u};
