import{c as e,u as t,a,r as s,j as r,$ as n,a0 as i,a1 as o,a2 as l,L as d,I as c,M as u,N as m,O as g,Q as h,R as y,a4 as x,B as p,s as j,h as f,i as v,f as b,d as N}from"./index-BKzwkbhU.js";import{C as w,u as _}from"./chartUtils-DiUYslSS.js";import{C as M,a as k,b as q,d as C,c as F}from"./card-d84NS_n5.js";import{u as S,P as V}from"./use-toast-C_SwDZk4.js";import{A as $,a as A}from"./alert-CN8C4i7Y.js";import{u as G,t as T,z as K}from"./index-Ce1Og8sm.js";import{I as O}from"./info-D6y8vdHT.js";import{P}from"./plus-BP6d835L.js";import{T as Y,i as D}from"./isSameMonth-CIK_ED-F.js";import{p as H}from"./parseISO-C5wMadzM.js";import{e as L}from"./endOfMonth-DamK16rX.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=e("Trophy",[["path",{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6",key:"17hqa7"}],["path",{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18",key:"lmptdp"}],["path",{d:"M4 22h16",key:"57wxv0"}],["path",{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22",key:"1nw9bq"}],["path",{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22",key:"1np0yb"}],["path",{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z",key:"u46fv3"}]]),B=K.object({title:K.string().min(1,"Title is required"),target_amount:K.number().min(1,"Amount must be greater than 0"),category:K.string().min(1,"Category is required"),deadline:K.string().min(1,"Deadline is required")});function Q({open:e,onOpenChange:f,goal:v}){const{user:b}=t(),{toast:N}=S(),_=a(),[M,k]=s.useState(!1),{register:q,handleSubmit:C,reset:F,setValue:V,formState:{errors:K}}=G({resolver:T(B),defaultValues:v?{title:v.title,target_amount:v.target_amount,category:v.category,deadline:v.deadline}:{title:"",target_amount:0,category:"",deadline:""}});return r.jsx(n,{open:e,onOpenChange:f,children:r.jsxs(i,{children:[r.jsx(o,{children:r.jsxs(l,{children:[v?"Edit":"New"," Goal"]})}),r.jsxs("form",{onSubmit:C((async e=>{if(b){k(!0);try{const t={title:e.title,target_amount:e.target_amount,category:e.category,deadline:e.deadline,user_id:b.id,current_amount:(null==v?void 0:v.current_amount)||0};if(v){const{error:e}=await j.from("goals").update(t).eq("id",v.id);if(e)throw e}else{const{error:e}=await j.from("goals").insert(t);if(e)throw e}N({title:`Goal ${v?"updated":"created"} successfully!`,description:`Your goal "${e.title}" has been ${v?"updated":"created"}.`}),_.invalidateQueries({queryKey:["goals"]}),F(),f(!1)}catch(t){N({title:"Error",description:"Failed to save the goal. Please try again.",variant:"destructive"})}finally{k(!1)}}})),className:"space-y-6 pt-8",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsx(d,{htmlFor:"title",children:"Title"}),r.jsx(c,{id:"title",...q("title"),placeholder:"Enter goal title"}),K.title&&r.jsx("p",{className:"text-sm text-destructive",children:K.title.message})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(d,{htmlFor:"target_amount",children:"Target Amount"}),r.jsx(c,{id:"target_amount",type:"number",step:"0.01",min:"0",...q("target_amount",{valueAsNumber:!0})}),K.target_amount&&r.jsx("p",{className:"text-sm text-destructive",children:K.target_amount.message})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(d,{htmlFor:"category",children:"Category"}),r.jsxs(u,{defaultValue:null==v?void 0:v.category,onValueChange:e=>V("category",e,{shouldValidate:!0}),children:[r.jsx(m,{children:r.jsx(g,{placeholder:"Select category"})}),r.jsx(h,{children:Object.keys(w).map((e=>r.jsx(y,{value:e,children:e},e)))})]}),K.category&&r.jsx("p",{className:"text-sm text-destructive",children:K.category.message})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(d,{htmlFor:"deadline",children:"Deadline"}),r.jsx(c,{id:"deadline",type:"date",...q("deadline")}),K.deadline&&r.jsx("p",{className:"text-sm text-destructive",children:K.deadline.message})]}),r.jsxs($,{className:"bg-muted/50 border-muted",children:[r.jsx(O,{className:"h-4 w-4"}),r.jsx(A,{className:"text-sm",children:"Goal progress is automatically calculated based on your monthly savings (Budget - Expenses) in the selected category. Progress starts at 0% each month and increases as you save money by staying under budget."})]}),r.jsxs("div",{className:"flex justify-end gap-2",children:[r.jsx(x,{asChild:!0,children:r.jsx(p,{variant:"outline",type:"button",children:"Cancel"})}),r.jsx(p,{type:"submit",disabled:M,children:M?"Saving...":"Save Goal"})]})]})]})})}function I(){const{user:e}=t(),{toast:n}=S(),[i,o]=s.useState(!1),[l,d]=s.useState(null),c=a(),{currencyCode:u}=f(),{data:m,isLoading:g}=_({queryKey:["goals",null==e?void 0:e.id],queryFn:async()=>{if(!e)return[];const{data:t,error:a}=await j.from("goals").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(a)throw a;return t},enabled:!!e}),{data:h}=_({queryKey:["expenses",null==e?void 0:e.id],queryFn:async()=>{if(!e)return[];const{data:t,error:a}=await j.from("expenses").select("*").eq("user_id",e.id);if(a)throw a;return t},enabled:!!e}),{data:y}=_({queryKey:["budgets",null==e?void 0:e.id],queryFn:async()=>{if(!e)return[];const{data:t,error:a}=await j.from("budgets").select("*").eq("user_id",e.id);if(a)throw a;return t},enabled:!!e}),x=e=>{if(!h||!y)return 0;const t=y.find((t=>t.category===e.category));if(!t)return 0;const a=new Date;N(a),L(a);const s=h.filter((t=>t.category===e.category&&D(new Date(t.date),a))).reduce(((e,t)=>e+("string"==typeof t.amount?parseFloat(t.amount):t.amount)),0);return t.amount-s},w=e=>{const t=x(e);if(t<=0)return 0;const a="string"==typeof e.target_amount?parseFloat(e.target_amount):e.target_amount;return 0===a?0:Math.min(t/a*100,100)};return g?r.jsx("div",{children:"Loading..."}):r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:"Financial Goals"}),r.jsx("p",{className:"text-muted-foreground",children:"Track and manage your financial targets"})]}),r.jsxs(p,{onClick:()=>{d(null),o(!0)},className:"mx-[7px] ",children:[r.jsx(P,{className:"mr-2 h-4 w-4"}),"Add Goal"]})]}),r.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:0===(null==m?void 0:m.length)?r.jsx("div",{className:"col-span-full text-center py-8",children:r.jsx("p",{className:"text-muted-foreground",children:'No goals yet. Click "Add Goal" to create your first financial goal!'})}):null==m?void 0:m.map((e=>{(async e=>{try{const t=x(e),a=Math.max(0,t);if(Math.abs(a-e.current_amount)>.01){const{error:t}=await j.from("goals").update({current_amount:a}).eq("id",e.id);if(t)throw t;c.invalidateQueries({queryKey:["goals"]})}}catch(t){}})(e);const t=x(e),a=w(e),s=Math.round(a),i=(e=>{const t=x(e),a=w(e),s=null==y?void 0:y.find((t=>t.category===e.category)),r=s?s.amount:0;return s&&0!==r?t<0?`You've overspent your ${e.category} budget by ${v(Math.abs(t),u)}. Try to reduce spending to get back on track.`:a<25?`Focus on reducing your ${e.category} spending to increase your savings. Try to save at least ${v(.25*e.target_amount,u)} this month.`:a<50?"You're making progress! Keep reducing expenses to reach your goal faster.":a<75?"Great progress! You're well on your way to reaching your goal.":a<100?"Almost there! Just a little more savings to reach your target.":"Congratulations! You've reached your savings goal!":"Set a monthly budget for this category to start tracking your savings progress."})(e),o=t<0,l=(null==y?void 0:y.some((t=>t.category===e.category&&t.amount>0)))??!1;return r.jsxs(M,{className:"relative",children:[r.jsxs(k,{children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs(q,{className:"flex items-center gap-2",children:[r.jsx(E,{className:a>=100?"text-yellow-500":"text-muted-foreground"}),e.title]}),r.jsxs(p,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:bg-destructive/10",onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this goal?"))try{const{error:t}=await j.from("goals").delete().eq("id",e);if(t)throw t;n({title:"Goal deleted",description:"Your goal has been successfully deleted."}),c.invalidateQueries({queryKey:["goals"]})}catch(t){n({title:"Error",description:"Failed to delete the goal. Please try again.",variant:"destructive"})}})(e.id),children:[r.jsx("span",{className:"sr-only",children:"Delete"}),r.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"h-4 w-4",children:[r.jsx("path",{d:"M3 6h18"}),r.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),r.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]})]})]}),r.jsxs(C,{children:["Target: ",v(e.target_amount,u),r.jsx("br",{}),"Deadline: ",b(H(e.deadline),"MMM dd, yyyy")]})]}),r.jsxs(F,{className:"space-y-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex justify-between text-sm",children:[r.jsxs("span",{children:["Progress (",s,"%)"]}),r.jsx("span",{children:o?r.jsxs("span",{className:"text-destructive",children:["-",v(Math.abs(t),u)]}):`${v(Math.max(0,t),u)} of ${v(e.target_amount,u)}`})]}),l?r.jsx(V,{value:a,indicatorClassName:o?"bg-destructive":a>=100?"bg-green-500":a>50?"bg-primary":a>25?"bg-amber-500":"bg-red-500"}):r.jsx($,{children:r.jsxs(A,{className:"text-amber-500",children:["No budget set for ",e.category,". Set a budget to track progress."]})}),r.jsx("div",{className:"mt-2 text-xs text-muted-foreground",children:r.jsxs("p",{children:["Based on ",e.category," budget savings this month"]})})]}),o&&r.jsxs($,{variant:"destructive",children:[r.jsx(Y,{className:"h-4 w-4"}),r.jsxs(A,{children:["You've overspent your ",e.category," budget. Progress is on hold until you start saving."]})]}),r.jsx($,{children:r.jsx(A,{children:i})})]})]},e.id)}))})]}),r.jsx(Q,{open:i,onOpenChange:o,goal:l})]})}export{I as default};
