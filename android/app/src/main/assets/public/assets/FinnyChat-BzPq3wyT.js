import{c as e,q as t,a8 as s,ae as a,af as n,ac as i,b0 as r,b1 as o,j as c,o as l,b2 as d,Y as u,X as m,r as x,e as g,B as p,v as f,w as h,b3 as y,b4 as w,E as v,m as b,U as j,u as N,h as D,t as S,s as C,p as M,i as A,ao as L,S as E}from"./index-BKzwkbhU.js";import{C as k}from"./card-d84NS_n5.js";import{A as I,a as z}from"./alert-CN8C4i7Y.js";import{T}from"./trash-2-CDOPMnMG.js";import{T as _,a as U,b as R,c as $,C as F,D as O}from"./tooltip-CZQ4xVpP.js";import{d as H}from"./differenceInCalendarMonths-CClJslyN.js";import{e as Y}from"./endOfMonth-DamK16rX.js";import{C as q}from"./circle-alert-Cu41asrS.js";import{P}from"./plus-BP6d835L.js";import{C as X}from"./chart-pie-nMKg2ABX.js";import{I as V}from"./info-D6y8vdHT.js";import{A as B}from"./arrow-right-AykwIgfE.js";import{L as G}from"./loader-circle-C-HlKtqs.js";
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=e("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]),W=e("PiggyBank",[["path",{d:"M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2V5z",key:"1ivx2i"}],["path",{d:"M2 9v1c0 1.1.9 2 2 2h1",key:"nm575m"}],["path",{d:"M16 11h.01",key:"xkw8gn"}]]),Q=e("SendHorizontal",[["path",{d:"M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z",key:"117uat"}],["path",{d:"M6 12h16",key:"s4cdu5"}]]);
/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function K(e,s){const a=t(e),n=t(s),i=a.getTime()-n.getTime();return i<0?-1:i>0?1:i}function Z(e){const s=t(e);return+function(e){const s=t(e);return s.setHours(23,59,59,999),s}(s)==+Y(s)}function ee(e,s,a){const n=function(e,s){return+t(e)-+t(s)}(e,s)/1e3;return(i=null==a?void 0:a.roundingMethod,e=>{const t=(i?Math[i]:Math.trunc)(e);return 0===t?0:t})(n);var i}function te(e,s,c){const l=a(),d=(null==c?void 0:c.locale)??l.locale??n,u=K(e,s);if(isNaN(u))throw new RangeError("Invalid time value");const m=Object.assign({},c,{addSuffix:null==c?void 0:c.addSuffix,comparison:u});let x,g;u>0?(x=t(s),g=t(e)):(x=t(e),g=t(s));const p=ee(g,x),f=(i(g)-i(x))/1e3,h=Math.round((p-f)/60);let y;if(h<2)return(null==c?void 0:c.includeSeconds)?p<5?d.formatDistance("lessThanXSeconds",5,m):p<10?d.formatDistance("lessThanXSeconds",10,m):p<20?d.formatDistance("lessThanXSeconds",20,m):p<40?d.formatDistance("halfAMinute",0,m):p<60?d.formatDistance("lessThanXMinutes",1,m):d.formatDistance("xMinutes",1,m):0===h?d.formatDistance("lessThanXMinutes",1,m):d.formatDistance("xMinutes",h,m);if(h<45)return d.formatDistance("xMinutes",h,m);if(h<90)return d.formatDistance("aboutXHours",1,m);if(h<r){const e=Math.round(h/60);return d.formatDistance("aboutXHours",e,m)}if(h<2520)return d.formatDistance("xDays",1,m);if(h<o){const e=Math.round(h/r);return d.formatDistance("xDays",e,m)}if(h<2*o)return y=Math.round(h/o),d.formatDistance("aboutXMonths",y,m);if(y=function(e,s){const a=t(e),n=t(s),i=K(a,n),r=Math.abs(H(a,n));let o;if(r<1)o=0;else{1===a.getMonth()&&a.getDate()>27&&a.setDate(30),a.setMonth(a.getMonth()-i*r);let s=K(a,n)===-i;Z(t(e))&&1===r&&1===K(e,n)&&(s=!1),o=i*(r-Number(s))}return 0===o?0:o}(g,x),y<12){const e=Math.round(h/o);return d.formatDistance("xMonths",e,m)}{const e=y%12,t=Math.trunc(y/12);return e<3?d.formatDistance("aboutXYears",t,m):e<9?d.formatDistance("overXYears",t,m):d.formatDistance("almostXYears",t+1,m)}}function se(e,t){return te(e,function(e){return s(e,Date.now())}(e),t)}const ae=d("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function ne({className:e,variant:t,...s}){return c.jsx("div",{className:l(ae({variant:t}),e),...s})}const ie=u.memo((({onClose:e,onReset:t})=>c.jsxs("div",{className:"flex items-center justify-between px-4 border-b border-border py-[13px]",children:[c.jsxs("div",{className:"flex items-center space-x-3",children:[c.jsxs("div",{className:"relative",children:[c.jsx("div",{className:"w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center py-0 px-0 my-[6px]",children:c.jsx("span",{className:"font-medium text-sm",children:"F"})}),c.jsx("span",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-background mx-[2px] my-[3px]"})]}),c.jsxs("div",{children:[c.jsxs("div",{className:"flex items-center space-x-2",children:[c.jsx("h3",{className:"font-medium text-base",children:"Finny"}),c.jsx(ne,{variant:"outline",className:"text-xs px-1.5",children:"AI"})]}),c.jsx("p",{className:"text-xs text-muted-foreground",children:"Financial Assistant"})]})]}),c.jsxs("div",{className:"flex items-center space-x-2",children:[t&&c.jsx("button",{onClick:t,className:"p-1.5 text-muted-foreground hover:text-destructive hover:bg-destructive/10 rounded-md transition-colors",title:"Reset conversation",children:c.jsx(T,{size:18})}),c.jsx("button",{onClick:e,className:"p-1.5 text-muted-foreground hover:text-accent-foreground hover:bg-accent/50 rounded-md transition-colors",children:c.jsx(m,{size:18})})]})]})));ie.displayName="ChatHeader";const re=({value:e,onChange:t,onSubmit:s,disabled:a,placeholder:n="Message Finny...",isLoading:i,isAuthenticated:r,isConnecting:o})=>{const l=x.useRef(null);g();const d=a||i||o||!r;return x.useEffect((()=>{l.current&&l.current.focus()}),[]),c.jsx("div",{className:"finny-chat-input my-[4px]",children:c.jsxs("form",{onSubmit:s,className:"finny-chat-input-container px-[2px] my-[3px] py-[7px]",children:[c.jsx("input",{type:"text",ref:l,value:e,onChange:t,disabled:d,className:"w-full",placeholder:o?"Connecting...":r?n:"Please log in to chat..."}),c.jsx(p,{type:"submit",size:"icon",disabled:d||!e.trim(),className:"rounded-full h-10 w-10 bg-green-500 hover:bg-green-600 text-white py-0 px-[9px]",children:c.jsx(Q,{size:18,className:"py-0"})})]})})};var oe={exports:{}},ce={},le=x;var de="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},ue=le.useState,me=le.useEffect,xe=le.useLayoutEffect,ge=le.useDebugValue;function pe(e){var t=e.getSnapshot;e=e.value;try{var s=t();return!de(e,s)}catch(a){return!0}}var fe="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var s=t(),a=ue({inst:{value:s,getSnapshot:t}}),n=a[0].inst,i=a[1];return xe((function(){n.value=s,n.getSnapshot=t,pe(n)&&i({inst:n})}),[e,s,t]),me((function(){return pe(n)&&i({inst:n}),e((function(){pe(n)&&i({inst:n})}))}),[e]),ge(s),s};ce.useSyncExternalStore=void 0!==le.useSyncExternalStore?le.useSyncExternalStore:fe,oe.exports=ce;var he=oe.exports;function ye(){return()=>{}}var we="Avatar",[ve,be]=f(we),[je,Ne]=ve(we),De=x.forwardRef(((e,t)=>{const{__scopeAvatar:s,...a}=e,[n,i]=x.useState("idle");return c.jsx(je,{scope:s,imageLoadingStatus:n,onImageLoadingStatusChange:i,children:c.jsx(h.span,{...a,ref:t})})}));De.displayName=we;var Se="AvatarImage",Ce=x.forwardRef(((e,t)=>{const{__scopeAvatar:s,src:a,onLoadingStatusChange:n=()=>{},...i}=e,r=Ne(Se,s),o=function(e,{referrerPolicy:t,crossOrigin:s}){const a=he.useSyncExternalStore(ye,(()=>!0),(()=>!1)),n=x.useRef(null),i=a?(n.current||(n.current=new window.Image),n.current):null,[r,o]=x.useState((()=>Le(i,e)));return w((()=>{o(Le(i,e))}),[i,e]),w((()=>{const e=e=>()=>{o(e)};if(!i)return;const a=e("loaded"),n=e("error");return i.addEventListener("load",a),i.addEventListener("error",n),t&&(i.referrerPolicy=t),"string"==typeof s&&(i.crossOrigin=s),()=>{i.removeEventListener("load",a),i.removeEventListener("error",n)}}),[i,s,t]),r}(a,i),l=y((e=>{n(e),r.onImageLoadingStatusChange(e)}));return w((()=>{"idle"!==o&&l(o)}),[o,l]),"loaded"===o?c.jsx(h.img,{...i,ref:t,src:a}):null}));Ce.displayName=Se;var Me="AvatarFallback",Ae=x.forwardRef(((e,t)=>{const{__scopeAvatar:s,delayMs:a,...n}=e,i=Ne(Me,s),[r,o]=x.useState(void 0===a);return x.useEffect((()=>{if(void 0!==a){const e=window.setTimeout((()=>o(!0)),a);return()=>window.clearTimeout(e)}}),[a]),r&&"loaded"!==i.imageLoadingStatus?c.jsx(h.span,{...n,ref:t}):null}));function Le(e,t){return e?t?(e.src!==t&&(e.src=t),e.complete&&e.naturalWidth>0?"loaded":"loading"):"error":"idle"}Ae.displayName=Me;var Ee=De,ke=Ce,Ie=Ae;const ze=x.forwardRef((({className:e,...t},s)=>c.jsx(Ee,{ref:s,className:l("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...t})));ze.displayName=Ee.displayName;const Te=x.forwardRef((({className:e,...t},s)=>c.jsx(ke,{ref:s,className:l("aspect-square h-full w-full",e),...t})));Te.displayName=ke.displayName;const _e=x.forwardRef((({className:e,...t},s)=>c.jsx(Ie,{ref:s,className:l("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...t})));_e.displayName=Ie.displayName;const Ue=({isUser:e,timestamp:t})=>{const s=se(new Date(t),{addSuffix:!0});return c.jsx(_,{children:c.jsxs(U,{children:[c.jsx(R,{asChild:!0,children:c.jsxs(ze,{children:[c.jsx(Te,{src:e?"/lovable-uploads/636d3f3b-f98d-4539-a003-5afe36b96701.png":"/lovable-uploads/37d37218-6a8c-434e-b03d-977ee786a0b1.png",alt:e?"User":"Finny"}),c.jsx(_e,{children:e?"You":"F"})]})}),c.jsxs($,{side:"top",children:[e?"You":"Finny"," • ",s]})]})})},Re=({content:e,isUser:t,isEmpathetic:s,isSuccess:a,isError:n,hasAction:i})=>t?null:c.jsxs("div",{className:"flex gap-1.5 flex-wrap",children:[i&&c.jsx(ne,{variant:"outline",className:`\n          text-[10px] py-0 px-1.5 \n          ${a?"bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-300":n?"bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-300":"bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-300"}\n        `,children:c.jsxs("span",{className:"flex items-center gap-1",children:[a&&c.jsx(v,{size:10}),n&&c.jsx(q,{size:10}),a?"Action completed":n?"Action failed":"Action"]})}),e.toLowerCase().includes("budget")&&c.jsx(ne,{variant:"outline",className:"text-[10px] py-0 px-1.5 bg-primary/10 text-primary",children:"budget"}),e.toLowerCase().includes("expense")&&c.jsx(ne,{variant:"outline",className:"text-[10px] py-0 px-1.5 bg-primary/10 text-primary",children:"expense"}),e.toLowerCase().includes("goal")&&c.jsx(ne,{variant:"outline",className:"text-[10px] py-0 px-1.5 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300",children:"goal"}),s&&c.jsx(ne,{variant:"outline",className:"text-[10px] py-0 px-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300",children:"support"})]}),$e=({timestamp:e})=>{return c.jsxs("div",{className:"text-[10px] text-white/70 ml-auto flex items-center gap-1",children:[c.jsx(J,{size:10}),(t=e,t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))]});var t},Fe=({hasAction:e,isSuccess:t,isError:s})=>e?c.jsx("div",{className:"flex gap-1.5 items-center mt-1",children:c.jsx(ne,{variant:"outline",className:`\n        text-[10px] py-0 px-1.5 \n        ${t?"bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-300":s?"bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-300":"bg-blue-100 dark:bg-blue-900/20 text-blue-800 dark:text-blue-300"}\n      `,children:c.jsxs("span",{className:"flex items-center gap-1",children:[t&&c.jsx(v,{size:10}),s&&c.jsx(q,{size:10}),t?"Action completed":s?"Action failed":"Action"]})})}):null,Oe=u.memo((({content:e,isUser:t,timestamp:s,hasAction:a})=>{const n=e.replace(/\[ACTION:(.*?)\]/g,""),i=n.includes("✅"),r=n.includes("❌"),o=!t&&(n.toLowerCase().includes("i understand")||n.toLowerCase().includes("don't worry")||n.toLowerCase().includes("sorry to hear")||n.toLowerCase().includes("completely understand"));return c.jsxs(b.div,{className:"flex gap-2 "+(t?"flex-row-reverse":"flex-row"),initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{type:"spring",stiffness:260,damping:20,delay:t?0:.1},children:[c.jsx(Ue,{isUser:t,timestamp:s}),c.jsxs("div",{className:`\n        max-w-[85%] rounded-lg px-3.5 py-2.5 shadow-sm\n        ${t?"bg-green-500 text-white":o?"bg-[#3e3559] text-white":"bg-[#352F44] text-white"}\n      `,children:[c.jsx("div",{className:"text-sm whitespace-pre-wrap break-words",children:n}),c.jsx(Fe,{hasAction:a,isSuccess:i,isError:r}),c.jsxs("div",{className:"flex justify-between items-center mt-1",children:[c.jsx(Re,{content:n,isUser:t,isEmpathetic:o,isSuccess:i,isError:r,hasAction:a}),c.jsx($e,{timestamp:s})]})]})]})}));Oe.displayName="FinnyMessage";const He=({replies:e,onSelect:t,isLoading:s,isAuthenticated:a})=>(g(),c.jsx("div",{className:"flex flex-wrap gap-3 px-3 py-4 bg-[#1A1F2C] border-t border-gray-800",children:e.map(((e,n)=>c.jsxs(p,{onClick:()=>t(e),disabled:s||!a,variant:"outline",size:"sm",className:"rounded-full text-sm shadow-sm hover:shadow-md transition-all flex items-center gap-2 bg-[#2D3748] border-gray-700 text-white hover:bg-[#374151]",children:[e.icon,e.text]},n)))})),Ye=()=>c.jsxs("div",{className:"flex gap-3 items-start px-4 py-2",children:[c.jsx("div",{className:"w-8 h-8 rounded-full bg-[#9b87f5] flex items-center justify-center",children:c.jsx("span",{className:"text-xs font-semibold text-white",children:"F"})}),c.jsx("div",{className:"bg-[#1A1F2C] rounded-2xl px-4 py-3 max-w-[85%]",children:c.jsx("div",{className:"flex items-center gap-3",children:c.jsx(b.div,{className:"h-0.5 w-5 bg-white/50 rounded-full",animate:{width:[5,20,5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}})})})]}),qe=[{text:"Add expense",action:"Help me add a new expense",icon:c.jsx(P,{size:14})},{text:"View spending",action:"Show my spending summary for this month",icon:c.jsx(F,{size:14})},{text:"Set budget",action:"I want to set up a new monthly budget",icon:c.jsx(j,{size:14})}],Pe="👋 Hi there! I'm Finny, your financial assistant. How can I help you today?",Xe="I'll need you to log in first so I can access your personal financial information.",Ve="finny_chat_messages";const Be=/show my (\w+) (spending|expenses|breakdown)/i,Ge=/(show|get|give) (me )?(a )?(summary|overview|report|analysis)/i,Je=/delete (?:my|the) ([\w\s]+) expense/i,We=/delete (?:my|the) ([\w\s]+) budget/i,Qe=/delete (?:my|the) (?:financial |savings )?goal(?: called| named)? ["|']?([^"']+)["|']?/i,Ke=/(?:set|create)(?: a)? (?:savings |financial )?goal(?: of)? \$?(\d+(?:\.\d+)?)(?: for| to reach| to save)? (?:by|at|on) ([a-zA-Z0-9\s,\/]+)/i,Ze=e=>{const[t,s]=x.useState(qe),{user:a}=N(),n=x.useRef(null),[i,r]=x.useState(!1),[o,l]=x.useState(!1),{currencyCode:d}=D(),{remainingDailyMessages:u,isMessageLimitReached:m}=M(),{messages:g,setMessages:p,newMessage:f,setNewMessage:h,isLoading:y,setIsLoading:w,isTyping:v,setIsTyping:b,oldestMessageTime:L,saveMessage:E,loadChatHistory:k,clearLocalStorage:I}=(()=>{const[e,t]=x.useState([]),[s,a]=x.useState(""),[n,i]=x.useState(!1),[r,o]=x.useState(!1),[c,l]=x.useState(),d=N(),u=(null==d?void 0:d.user)||null,m=D();null==m||m.currencyCode,x.useEffect((()=>{u?g():(t([]),l(void 0))}),[u]);const g=async()=>{try{const e=localStorage.getItem(Ve);if(e){const s=JSON.parse(e),a=new Date,n=s.filter((e=>!e.expiresAt||new Date(e.expiresAt)>a)).map((e=>({...e,timestamp:new Date(e.timestamp),expiresAt:e.expiresAt?new Date(e.expiresAt):void 0})));if(n.length>0){t(n);const e=n.map((e=>e.timestamp.getTime())),s=new Date(Math.min(...e));l(s)}}}catch(s){}return e.length};return{messages:e,setMessages:t,newMessage:s,setNewMessage:a,isLoading:n,setIsLoading:i,isTyping:r,setIsTyping:o,oldestMessageTime:c,saveMessage:e=>{try{e.expiresAt||(e.expiresAt=new Date(Date.now()+864e5));const s=localStorage.getItem(Ve);let a=[];if(s)try{a=JSON.parse(s)}catch(t){}if(a.some((t=>t.id===e.id)))return;const n={...e,timestamp:e.timestamp.toISOString(),expiresAt:e.expiresAt?e.expiresAt.toISOString():void 0},i=[...a,n];localStorage.setItem(Ve,JSON.stringify(i)),(!c||e.timestamp<c)&&l(e.timestamp)}catch(s){S.error("Failed to save message")}},loadChatHistory:g,clearLocalStorage:()=>{try{localStorage.removeItem(Ve)}catch(e){}}}})();x.useEffect((()=>{n.current&&n.current.scrollIntoView({behavior:"smooth"})}),[g,v]),x.useEffect((()=>{if(!o&&a)_(),l(!0);else if(!a&&o){l(!1);const e={id:"1",content:Xe,isUser:!1,timestamp:new Date,expiresAt:new Date(Date.now()+864e5)};p([e])}}),[a,o]),x.useEffect((()=>{if(a&&1===g.length&&!g[0].isUser&&g[0].content.includes("log in first"))p([]),l(!1);else if(!a&&0===g.length){const e={id:"1",content:Xe,isUser:!1,timestamp:new Date,expiresAt:new Date(Date.now()+864e5)};p([e])}}),[a]);const z=async(e,t)=>{e&&e.preventDefault();let n=t||f;if(!n.trim()||y)return;if(!a)return void S.error("Please log in to chat with Finny");if(m)return void S.error("Daily message limit reached (10 messages). Please try again tomorrow.");const i={id:Date.now().toString(),content:n,isUser:!0,timestamp:new Date,expiresAt:new Date(Date.now()+864e5)};p((e=>[...e,i])),E(i),h(""),w(!0),b(!0);try{const e=[...g.slice(-5),i],t=n.match(Be),r=n.match(Ge),o=n.match(Je),l=n.match(We),u=n.match(Qe),m=n.match(Ke);let x="general",f=null;m&&(n=`${n}\n\nPlease create a goal with the following details: \n        - amount: ${m[1]}\n        - deadline: ${m[2]}\n        - title: "Savings Goal"\n        - category: Savings`),t?(x="category",f=t[1]):r?x="summary":o?(x="delete_expense",f=o[1].trim()):l?(x="delete_budget",f=l[1].trim()):u&&(x="delete_goal",f=u[1].trim());const h=await async function(e,t,s,a="general",n=null,i="USD"){if(!t)throw new Error("You must be logged in to use Finny");try{const{data:r}=await C.from("profiles").select("full_name, age, gender, preferred_currency").eq("id",t).single(),{data:o,error:c}=await C.functions.invoke("finny-chat",{body:{message:e,userId:t,chatHistory:s,analysisType:a,specificCategory:n,currencyCode:(null==r?void 0:r.preferred_currency)||i,userName:null==r?void 0:r.full_name,userAge:null==r?void 0:r.age,userGender:null==r?void 0:r.gender}});if(c)throw new Error(`Failed to get response: ${c.message}`);if(o.action&&"add_expense"===o.action.type){const e=new CustomEvent("expense-added",{detail:{timestamp:Date.now(),expenseData:o.action}});window.dispatchEvent(e),setTimeout((()=>{const e=new CustomEvent("expenses-updated",{detail:{timestamp:Date.now(),expenseData:o.action}});window.dispatchEvent(e)}),300),setTimeout((()=>{const e=new CustomEvent("expense-refresh",{detail:{timestamp:Date.now(),expenseData:o.action}});window.dispatchEvent(e)}),1e3)}else if(!o.action||"set_budget"!==o.action.type&&"update_budget"!==o.action.type&&"delete_budget"!==o.action.type){if(o.action&&("set_goal"===o.action.type||"update_goal"===o.action.type||"delete_goal"===o.action.type)){const e=new CustomEvent("goal-updated",{detail:{timestamp:Date.now(),goalData:o.action}});window.dispatchEvent(e)}}else{const e=new CustomEvent("budget-updated",{detail:{timestamp:Date.now(),budgetData:o.action}});window.dispatchEvent(e)}return o}catch(r){throw r}}(n,a.id,e,x,f,d);b(!1);const y=h.response.includes("✅")||h.rawResponse.includes("[ACTION:"),w={id:Date.now().toString(),content:h.response,isUser:!1,timestamp:new Date,hasAction:y,expiresAt:new Date(Date.now()+864e5)};p((e=>[...e,w])),E(w);const v=function(e,t,s){let a=[...qe];e.toLowerCase().includes("budget")||t.toLowerCase().includes("budget")?a=[{text:"Show my budget",action:"Show me my budget",icon:c.jsx(X,{size:14})},{text:"Update budget",action:"I'd like to update my budget",icon:c.jsx(P,{size:14})},{text:"Budget analysis",action:"How am I doing with my budgets this month?",icon:c.jsx(F,{size:14})},{text:"Delete budget",action:"I want to delete a budget",icon:c.jsx(T,{size:14})}]:e.toLowerCase().includes("expense")||t.toLowerCase().includes("expense")?a=[{text:"Add expense",action:"I want to add an expense",icon:c.jsx(P,{size:14})},{text:"Recent expenses",action:"Show my recent expenses",icon:c.jsx(j,{size:14})},{text:"Category analysis",action:"Show my spending by category",icon:c.jsx(X,{size:14})},{text:"Delete expense",action:"Delete my latest expense",icon:c.jsx(T,{size:14})}]:s?a=[{text:"All categories",action:"Show my spending by category",icon:c.jsx(X,{size:14})},{text:`Add ${s[1]}`,action:`Add a ${s[1]} expense`,icon:c.jsx(P,{size:14})},{text:"Monthly spending",action:"What's my total spending this month?",icon:c.jsx(O,{size:14})},{text:"Spending insights",action:"Give me insights on my spending",icon:c.jsx(V,{size:14})}]:(e.toLowerCase().includes("goal")||t.toLowerCase().includes("goal"))&&(a=[{text:"Progress update",action:"What's my progress on my goals?",icon:c.jsx(W,{size:14})},{text:"Set new goal",action:"I want to set a new savings goal",icon:c.jsx(P,{size:14})},{text:"Update goal",action:"How can I update my goal progress?",icon:c.jsx(B,{size:14})},{text:"Delete goal",action:"Delete my savings goal",icon:c.jsx(T,{size:14})}]),t.includes("$")&&(a.some((e=>e.text.toLowerCase().includes("visualization")||e.text.toLowerCase().includes("chart")))||(a=[...a.slice(0,3),{text:"Visualize data",action:"Generate a chart of this data",icon:c.jsx(X,{size:14})}]));return a}(n,h.response,t);s(v)}catch(r){S.error(`Sorry, I couldn't process that request: ${r.message}`),b(!1);const e={id:Date.now().toString(),content:"Sorry, I'm having trouble processing your request. Please try again later.",isUser:!1,timestamp:new Date,expiresAt:new Date(Date.now()+864e5)};p((t=>[...t,e])),E(e)}finally{w(!1)}},_=async()=>{var e;if(a){r(!0);try{if(await k()>0)return a&&p((e=>e.filter((e=>!(e.content.includes("log in first")&&!e.isUser))))),void r(!1);const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),1).toISOString().split("T")[0],i=new Date(t.getFullYear(),t.getMonth()+1,0).toISOString().split("T")[0],{data:o,error:l}=await C.from("expenses").select("amount, category").eq("user_id",a.id).gte("date",n).lte("date",i);if(l)throw l;const{data:u,error:m}=await C.from("expenses").select("*").eq("user_id",a.id).order("date",{ascending:!1}).limit(5);if(m)throw m;const{data:x,error:g}=await C.from("budgets").select("*").eq("user_id",a.id);if(g)throw g;const f=(null==o?void 0:o.reduce(((e,t)=>e+Number(t.amount)),0))||0;let h=Pe;if(o&&o.length>0){const t={};o.forEach((e=>{t[e.category]=(t[e.category]||0)+Number(e.amount)}));const n=Object.entries(t).sort(((e,t)=>t[1]-e[1]))[0],i=(null==(e=null==a?void 0:a.user_metadata)?void 0:e.full_name)||"";h=`Hey ${i}! 🎉 Finny here to help with your finances.\nLooks like you've spent ${A(f,d)} this month. ${n[0]} took ${A(n[1],d)} — shall we explore ways to save? 🧠`;let r=[];if(r.push({text:`${n[0]} analysis`,action:`Show my ${n[0].toLowerCase()} spending breakdown`,icon:c.jsx(j,{size:14})}),x&&x.length>0){const e={};x.forEach((t=>{e[t.category]=t.amount}));for(const[s,a]of Object.entries(t))if(e[s]&&a>e[s]){r.push({text:`${s} budget alert`,action:`How am I doing with my ${s.toLowerCase()} budget?`,icon:c.jsx(V,{size:14})});break}}if(u&&u.length>0){const e=u[0];r.push({text:`Add ${e.category}`,action:`I want to add a new ${e.category.toLowerCase()} expense`,icon:c.jsx(P,{size:14})})}const l=["Transportation","Food","Housing","Entertainment"];for(const e of l)if(t[e]&&!r.some((t=>t.text.includes(e)))){r.push({text:`${e} breakdown`,action:`Show my ${e.toLowerCase()} spending breakdown`,icon:c.jsx(j,{size:14})});break}s([...r.slice(0,3),...qe.slice(0,1)])}b(!0),setTimeout((()=>{const e={id:"1",content:h,isUser:!1,timestamp:new Date,expiresAt:new Date(Date.now()+864e5)};p((t=>0===t.length?[e]:t)),E(e),b(!1)}),1500)}catch(t){const e={id:"1",content:"I've connected to your account, but I'm having trouble retrieving your latest financial data. How can I help you today?",isUser:!1,timestamp:new Date,expiresAt:new Date(Date.now()+864e5)};p([e]),E(e)}finally{r(!1)}}};return{messages:g,newMessage:f,setNewMessage:h,isLoading:y,isConnectingToData:i,isTyping:v,quickReplies:t,messagesEndRef:n,handleSendMessage:z,handleQuickReply:e=>{y||!a||m?m&&S.error("Daily message limit reached (10 messages). Please try again tomorrow."):z(null,e.action)},oldestMessageTime:L,resetChat:()=>{if(I(),p([]),l(!1),a)setTimeout((()=>{_()}),500);else{const e={id:"1",content:Xe,isUser:!1,timestamp:new Date,expiresAt:new Date(Date.now()+864e5)};p([e])}},remainingDailyMessages:u,isMessageLimitReached:m}},et=({oldestMessageTime:e})=>{const[t,s]=x.useState("");return x.useEffect((()=>{if(!e)return;const t=()=>{const t=new Date(e.getTime()+864e5);s(se(t))};t();const a=setInterval(t,6e4);return()=>clearInterval(a)}),[e]),e?c.jsxs("div",{className:"flex items-center gap-2 rounded-lg bg-gray-800/40 p-3 mb-4",children:[c.jsx(V,{className:"h-4 w-4 text-gray-400 flex-shrink-0"}),c.jsxs("p",{className:"text-xs text-gray-300",children:["Chat history is saved for 24 hours. Older messages will be automatically removed in ",t,"."]})]}):null},tt=({isOpen:e,onClose:t,config:s})=>{const a=g(),n=x.useRef(null),{user:i}=N(),{messages:r,newMessage:o,setNewMessage:l,isLoading:d,isConnectingToData:u,isTyping:m,quickReplies:p,messagesEndRef:f,handleSendMessage:h,handleQuickReply:y,oldestMessageTime:w,resetChat:v}=Ze();x.useEffect((()=>{}),[e,i]);const j=r.filter((e=>!(i&&!e.isUser&&e.content.includes("log in first")))),D=1===j.length&&!j[0].isUser&&j[0].content.includes("log in")&&!i;return x.useEffect((()=>{const s=n.current;if(!a||!s||!e)return;let i=0,r=!1;const o=e=>{i=e.touches[0].clientY,r=!1},c=e=>{e.touches[0].clientY-i>50&&(r=!0)},l=()=>{r&&t()};return s.addEventListener("touchstart",o),s.addEventListener("touchmove",c),s.addEventListener("touchend",l),()=>{s.removeEventListener("touchstart",o),s.removeEventListener("touchmove",c),s.removeEventListener("touchend",l)}}),[a,e,t]),c.jsx(L,{children:e&&c.jsx(b.div,{ref:n,className:"fixed z-40 "+(a?"inset-0 m-0 flex flex-col":"bottom-20 right-4 md:bottom-24 md:right-8 w-[90vw] sm:w-[400px]"),initial:{opacity:0,y:20,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:20,scale:.95},transition:{type:"spring",damping:25,stiffness:300},children:c.jsx(k,{className:"finny-chat-card flex flex-col h-full",children:c.jsxs("div",{className:"flex flex-col h-full",children:[c.jsx("div",{className:"flex-none",children:c.jsx(ie,{onClose:t,onReset:v})}),c.jsx("div",{className:"flex-1 overflow-hidden",children:c.jsx(E,{className:"h-full no-scrollbar touch-scroll-container",children:c.jsxs("div",{className:"finny-messages-container",children:[!i&&!D&&c.jsxs(I,{variant:"default",className:"mb-4 bg-muted/50 border-primary/20 rounded-lg",children:[c.jsx(V,{className:"h-4 w-4 text-primary"}),c.jsx(z,{className:"text-sm",children:"You need to log in to use Finny's personalized features."})]}),i&&w&&c.jsx(et,{oldestMessageTime:w}),u&&i&&c.jsxs("div",{className:"flex flex-col items-center justify-center py-6 space-y-3",children:[c.jsxs("div",{className:"relative w-10 h-10",children:[c.jsx("div",{className:"absolute inset-0 rounded-full animate-pulse bg-primary/20"}),c.jsx(G,{className:"absolute inset-0 w-10 h-10 animate-spin text-primary"})]}),c.jsx("span",{className:"text-xs text-muted-foreground",children:"Connecting to your financial data..."})]}),j.map((e=>c.jsx(Oe,{content:e.content,isUser:e.isUser,timestamp:e.timestamp,hasAction:e.hasAction,visualData:e.visualData},e.id))),m&&c.jsx(Ye,{}),!d&&!m&&j.length>0&&!j[j.length-1].isUser&&c.jsx(He,{replies:p,onSelect:y,isLoading:d,isAuthenticated:!!i}),c.jsx("div",{ref:f})]})})}),c.jsx("div",{className:"flex-none",children:c.jsx(re,{value:o,onChange:e=>l(e.target.value),onSubmit:h,disabled:D&&!i,isLoading:d,isAuthenticated:!!i,isConnecting:u})})]})})})})};export{tt as default};
